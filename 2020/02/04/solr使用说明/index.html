<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>solr使用说明 | 湖畔小屋</title><meta name="description" content="solr使用说明"><meta name="author" content="美式不加糖"><meta name="copyright" content="美式不加糖"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="solr使用说明"><meta name="twitter:description" content="solr使用说明"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="solr使用说明"><meta property="og:url" content="http://yoursite.com/2020/02/04/solr%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/"><meta property="og:site_name" content="湖畔小屋"><meta property="og:description" content="solr使用说明"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/02/04/solr%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/"><link rel="prev" title="solr测试数据" href="http://yoursite.com/2020/02/04/solr-%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE/"><link rel="next" title="solr的问题排查（ugc 项目问题排查）" href="http://yoursite.com/2020/02/04/solr%E7%9A%84%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">湖畔小屋</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">28</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">9</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">20</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#solr使用中遇到的一些问题"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">solr使用中遇到的一些问题</span></a></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#solr使用中遇到的一些问题"><span class="toc-number">1.</span> <span class="toc-text">solr使用中遇到的一些问题</span></a></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">solr使用说明</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-02-04<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-02-18</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/solr/">solr</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><html><head></head><body><p><strong>1.solr 的 使用说明</strong></p>
<p>（1）solr core : solr 每个core 都是以 文档为单位，每个文档就是一条数据，每个文档上 有多个字段。  solr的查询结果就是一个个文档。</p>
<pre><code>ugc_engine 为 ugc的文章 引擎 ， 以文章作为文档，文章上 有多条属性

ugc_arr_engine  为 ugc的suggest 中的目的地引擎。 以目的地作为文档，每个目的地上带有多个属性。</code></pre><p><strong>2.solr 的配置</strong></p>
<p>（1） schema.xml  中 配置的是 字段 和 字段类型</p>
<p>例子：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><!--精选图片--></span><br><span class="line"><field name="imgs" type="string" indexed="true" stored="true" multivalued="true"></field></span><br><span class="line"><!--文章内容--></span><br><span class="line"><field name="content" type="string" indexed="false" stored="true" multivalued="true"></field></span><br><span class="line"><!--文章内容索引--></span><br><span class="line"><field name="search_content" type="text_bamboo" indexed="true" multivalued="true"></field></span><br><span class="line"><copyfield source="content" dest="search_content"></copyfield></span><br><span class="line"><!--曝光出发地--></span><br><span class="line"><field name="departure" type="string" indexed="true" stored="true" multivalued="true"></field></span><br><span class="line"><field name="departure_search" type="textgen" indexed="true" stored="true" multivalued="true"></field></span><br></pre></td></tr></tbody></table></figure></div>



<p>说明：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <uniquekey>en_id</uniquekey>   主键：  高亮的时候，solr 会在对应的map中以 主键为key  存储数据</span><br><span class="line"></span><br><span class="line">required="true"  必须有值，否则无法存入solr</span><br><span class="line"></span><br><span class="line">stored="true" 是否存储，有些专门用来做搜索的不需要储存</span><br><span class="line"></span><br><span class="line">indexed="true" 是否创建索引</span><br><span class="line"></span><br><span class="line">type="text_bamboo"  字段的类型，一般可以使string boolean等类型，也可以是自定义，如text_bamboo ,自定义的中文分词器，在对应的 fieldType 中 查看具体的配置 。</span><br><span class="line"></span><br><span class="line"><copyfield source="content" dest="search_content">复制字段 ， contetn字段用来保存，search_content 用来分词 搜索</copyfield></span><br><span class="line"></span><br><span class="line">multiValued="true" 多值字段，一个字段可以是多值，设置后 为数组， 对该字段搜索，如果数组中有命中的数，即 该条 文章  被命中  ，如， destination[“北京”，“天津”]</span><br><span class="line"></span><br><span class="line"><dynamictype name="* " type="string">动态字段，可以让solr接收未定义字段的数据</dynamictype></span><br><span class="line"></span><br><span class="line">fieldType：定义字段类型</span><br><span class="line"></span><br><span class="line">可以自家看下 tokenizer 和filter 去配置 字段类型，NGramFilterFactory可以用来分词， 做前缀匹配和中部匹配</span><br></pre></td></tr></tbody></table></figure></div>



<p>字段类型说明</p>
<p>analyzer ：index 表示 建索引的时候使用， query 标示 查询的时候使用， 实例测试 见 solr的 analyse 组件</p>
<p>通过tokenizer 去对数据做处理，然后filter 一层一层的去做处理</p>
<p>例子：这是一个前缀匹配的字段类型</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><fieldtype name="text_ngram_prefix" class="solr.TextField" positionincrementgap="100"></fieldtype></span><br><span class="line"> <analyzer type="index"></analyzer></span><br><span class="line"> <tokenizer class="solr.KeywordTokenizerFactory"> solr 自带的 分词类型 </tokenizer></span><br><span class="line"> <filter class="solr.StopFilterFactory" ignorecase="true" words="chinesestopword.txt" enablepositionincrements="true"> 去除停词，暂时没使用</filter></span><br><span class="line"> <filter class="solr.EdgeNGramFilterFactory" mingramsize="1" maxgramsize="8"> solr 提供的分词filter，可以用来做前缀匹配和 中部匹配， 会将 一个词 如 去哪儿网， 拆成 去 去哪 去哪儿 去哪儿网， 通过过min/maxGramSize 控制精度</filter></span><br><span class="line"> <filter class="solr.LowerCaseFilterFactory"> 最小值过滤，中文没用，</filter></span><br><span class="line"> </span><br><span class="line"> <analyzer type="query"></analyzer></span><br><span class="line"> <tokenizer class="solr.KeywordTokenizerFactory"></tokenizer></span><br><span class="line"> <filter class="solr.StopFilterFactory" ignorecase="true" words="chinesestopword.txt" enablepositionincrements="true"></filter></span><br><span class="line"> <!--<filter class="solr.EdgeNGramFilterFactory" minGramSize="1" maxGramSize="8"/>--> // 查询时 不进行前缀分词， 即 对查询不分词</span><br><span class="line"> <filter class="solr.LowerCaseFilterFactory"></filter></span><br><span class="line"> </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></div>



<p>效果截图</p>
<p><a href="https://user-gold-cdn.xitu.io/2018/2/7/1616f67dff84a15e?w=1055&h=716&f=png&s=66076" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://user-gold-cdn.xitu.io/2018/2/7/1616f67dff84a15e?w=1055&h=716&f=png&s=66076" class="lazyload"></a></p>
<p>（2） solrConfig.xml 用来配置 solr的 整体配置，一般用不到， ugc的solr 是根据搜索组来的，中文分词等都是使用搜索的配置。</p>
<p><strong>3.solr的 使用语法</strong></p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">在solr上 直接查询数据。 选择 solr core， query，添加参数，查询</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line"></span><br><span class="line">q:   关键字查询，   如：en_id:3803042451   查询 en_id 字段（）为xx的文章信息。</span><br><span class="line"></span><br><span class="line">fq: 多条件查询，类似 where  ，添加查询条件 如 q=search_des_path:北京  & fq= status:0  ， 增加status：0的限制条件。同时满足的数据</span><br><span class="line"></span><br><span class="line">sort:针对某字段排序，desc 降序，如 sort = property desc  ,按照property 字段降序排列 。 （如 不加限制，默认按照查询相关度分数 降序排列）</span><br><span class="line"></span><br><span class="line">start / rows ： 从start条开始，展示rows行数据</span><br><span class="line"></span><br><span class="line">fl: 字段过滤， 如果填写字段名，只显示该字段的数据，字段之间以 逗号分割， 如 en_id,id</span><br><span class="line"></span><br><span class="line">facet：类似 sql的group ，分组，和分组下的结果</span><br><span class="line"></span><br><span class="line">hl ： 命中 高亮</span><br></pre></td></tr></tbody></table></figure></div>



<p><strong>facet</strong>: 统计，facet.field 设置字段名 如channel_id， 会在显示数据下facet_counts 里显示 ，符合当前查询条件的 该字段(channel_id)的每个数据对应的文章数量。</p>
<p>facet 只会统计 符合条件的文章数</p>
<p>在solrj 中使用</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sq.addFacetField(con.getFacetField());</span><br><span class="line">sq.setFacet(true);</span><br></pre></td></tr></tbody></table></figure></div>



<p>solr的facet 结果：</p>
<p><a href="https://user-gold-cdn.xitu.io/2018/2/7/1616f6afdb4cd5b6?w=246&h=236&f=png&s=4790" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://user-gold-cdn.xitu.io/2018/2/7/1616f6afdb4cd5b6?w=246&h=236&f=png&s=4790" class="lazyload"></a></p>
<p>facet的结果处理：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List<facetfield.count> counts= rs.getFacetField(con.getFacetField()).getValues();</facetfield.count></span><br><span class="line">Map<string,long> map = new HashMap<>();</string,long></span><br><span class="line">for(FacetField.Count c : counts){</span><br><span class="line">    map.put(c.getName() , c.getCount());</span><br><span class="line">}</span><br><span class="line">return map;</span><br></pre></td></tr></tbody></table></figure></div>



<p>场景： 主要用在 ugc的 频道查询，出哪些频道</p>
<p>hl ：高亮</p>
<p>场景： 搜索/suggest ，代码 ：com.xxxx.xxxx.ugc.query.controller.SearchController</p>
<p>开启高亮：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private void buildHighlightQuery(SolrQuery sq){</span><br><span class="line"> sq.setHighlight(true); // 开启高亮组件或用query.setParam("hl", "true");</span><br><span class="line"> sq.addHighlightField("search_title,search_content");// 高亮字段</span><br><span class="line"> sq.setHighlightSimplePre("<font class="\" matched\"">");//高亮字段的模式</font></span><font class="\" matched\""><br><span class="line"> sq.setHighlightSimplePost("</span></font>");<br><span class="line"> sq.setHighlightFragsize(200);</span><br><span class="line"></span><br><span class="line">使用时需要开启edismax</span><br></pre></td></tr></tbody></table></figure></div>



<p>示例url：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxxxxxxxx/qsearch/ugc_engine/select?q=search_content%3A%E4%B8%8A%E6%B5%B7&fl=search_content&wt=json&indent=true&defType=edismax&stopwords=true&lowercaseOperators=true&hl=true&hl.fl=search_title%2Csearch_content&hl.simple.pre=%3Cem%3E&hl.simple.post=%3C%2Fem%3E&hl.requireFieldMatch=true</span><br></pre></td></tr></tbody></table></figure></div>



<p>结果处理：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map<string, list<string>> match = hl.get(articleMo.getDappId().getEid());// 获取高亮，即命中的文字</string,></span><br><span class="line">if(match != null){</span><br><span class="line">    if(match.get("search_title") != null){</span><br><span class="line">        articleMo.setTitle( getTitleByHl(match)  );</span><br></pre></td></tr></tbody></table></figure></div>



<p>solr 高亮结果示例：</p>
<p><a href="https://user-gold-cdn.xitu.io/2018/2/7/1616f6c1bf6cebf8?w=503&h=377&f=png&s=39295" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://user-gold-cdn.xitu.io/2018/2/7/1616f6c1bf6cebf8?w=503&h=377&f=png&s=39295" class="lazyload"></a></p>
<p>（2）在Analysis 中 验证 具体的fieldType 的分词/查询效果</p>
<p>（3）上传数据，由数据抽取组提供，也可以手动传，json</p>
<pre><code>a.直接操作，如删除某条数据，solr core的页面 Documents 中，添加置顶格式的内容

b.json文件，</code></pre><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> post 方法，update/json?commit=true， 如 http://l-dapp2.m.vc.dev.cn0.xxx.com:9112/qsearch/ugc_engine/update/json?commit=true</span><br><span class="line"></span><br><span class="line">在Hears中加，Content-type:json ，</span><br><span class="line"></span><br><span class="line">在body中添加json文件(binary)</span><br></pre></td></tr></tbody></table></figure></div>



<p>开始的时候使用mock的数据</p>
<p>（4）solr语句 示例。 如，ugc 业务中的 solr 搜索查询语句</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxxxxxxxxxxxx/qsearch/ugc_engine/select?q=%E9%95%BF%E5%9F%8E&defType=edismax&qf=search_destination^1000+search_title^100+search_content^10&tie=1&sort=score+desc,quality+desc,audit_time+desc&hl=true&hl.fl=search_title,search_content&hl.simple.pre=%3Cfont+class%3D%22matched%22%3E&hl.simple.post=%3C/font%3E&hl.fragsize=200&start=0&rows=100&fl=score,en_id,id,title,imgs,audit_time,destination,departure,quality,user_id,user_en_id,user_info,channel_id,channel_en_id,content&fq=audit_time:+[+*+TO+NOW+]+AND+end_time:[+NOW+TO+*]&fq=status:0</span><br></pre></td></tr></tbody></table></figure></div>



<p>3.ugc 中solr 引擎的使用。</p>
<p>（1）业务接口</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a.文章列表： ArticleController：list 方法，</span><br><span class="line"></span><br><span class="line">b.搜索列表：SearchController :query 方法</span><br></pre></td></tr></tbody></table></figure></div>



<p>（2）solr utils 使用（.SolrUtils）</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">使用solr 工具类 SolrUtils， 使用solrj 连接基于zookeeper的solrClou/d，进行查询。</span><br><span class="line"></span><br><span class="line">如：        QueryResponse rs = SolrUtils.search(solrCollection,sq);      </span><br><span class="line"></span><br><span class="line">调用 public static QueryResponse search (String solrCollection , SolrQuery solrQuery )方法 ，</span><br><span class="line"></span><br><span class="line">           参数 solrCollection ，要查询的solr core的名字，solrQuery查询条件</span><br><span class="line"></span><br><span class="line">其他方法说明：public static SolrDocumentList search ， 返回结果是数据列表，不会有高亮和 分组等功能</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">该工具 会在com.xxxx.dapp.ugc.config.UGCSearchConfig 中， 在spring 启动的工程中 加载</span><br></pre></td></tr></tbody></table></figure></div>



<p>（3）返回结果处理</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">（1）搜索-----高亮处理</span><br><span class="line">ArticleMoService的buildHightlightContent方法，从reponse的hl中取出命中的数据，用来替换 solr的正常返回数据。</span><br><span class="line"></span><br><span class="line">ugc：这块的逻辑是，命中的内容，获取命中词这句话，从这句话开始，返回给前台展示。</span><br><span class="line"></span><br><span class="line">（2）正常处理</span><br><span class="line"></span><br><span class="line">ArticleMo 方法 中进行对象转换</span><br><span class="line"></span><br><span class="line">（3）频道 ----facet处理</span><br><span class="line"></span><br><span class="line">SimpleChannelSearchService中的buildMappingByRs 方法</span><br><span class="line"></span><br><span class="line">从返回的solr Response 中 根据facet的字段 即 频道 字段 获取facet的内容, 与数据库查出的频道 做过滤。如   List<facetfield.count> counts= rs.getFacetField(con.getFacetField()).getValues();</facetfield.count></span><br></pre></td></tr></tbody></table></figure></div>



<p>（4）ugc 业务中 solr 查询条件的构建：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">如 articleController ，  buildListSolrQurey方法</span><br><span class="line"></span><br><span class="line">a.添加 过滤 查询 限制 ，出发地 departure 为中国，或者departure有 dep字段的 文章</span><br><span class="line"></span><br><span class="line">          sq.addFilterQuery("+(departure:"+ dep.trim() +" OR departure:中国)");</span><br><span class="line"></span><br><span class="line">b.时间限制，solr中的时间默认是UTC时区，用 NOW 关键字 进行比较的时候，需要+8小时才是北京时间，如</span><br><span class="line"></span><br><span class="line">          sq.addFilterQuery("audit_time: [ * TO NOW+8HOUR ] AND end_time:[ NOW+8HOUR TO *]")</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c.加权：用bq 参数 或qf 参数，区别：bq 在主查询基础上 增加权重， qf：将q中的参数在qf中指定的字段中 进行查询 并加上权重</span><br><span class="line"></span><br><span class="line">如，文章列表的权重</span><br><span class="line"></span><br><span class="line">bq：</span><br><span class="line"></span><br><span class="line">sq.set("defType","edismax");</span><br><span class="line">sq.add("bq","property:(1)^5000");//周边</span><br><span class="line">sq.add("bq","property:(0)^1000");//中性</span><br><span class="line">sq.add("bq","property:(2)^3");//游客</span><br><span class="line"></span><br><span class="line">启用 edismax，增加bq参数，() 中的是字段对应的直^后为加的权重</span><br><span class="line"></span><br><span class="line">qf：</span><br><span class="line"></span><br><span class="line">sq.set("defType","edismax");</span><br><span class="line">sq.set("qf","search_destination^1000 search_title^100 search_content^10");//权重，使有标签>无标签 =>标题正文都有>标题有>正文有</span><br><span class="line">sq.set("tie","1");//tie 可以让三个字段命中的权重累加，如果没有tie 取权重最高的字段加权</span><br><span class="line"></span><br><span class="line">qf 默认会在命中的三个字段中选择权重最高的 作为当前权重，可以通过设置tie :1  使得权重可以累加。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在solr query中 的fl 上加 score 字段，会显示该数据是多少评分， 在对应的solr query 后加 debug=true 参数，可以查看这次查询的评分构成</span><br></pre></td></tr></tbody></table></figure></div>



<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bq参数示例：</span><br><span class="line"></span><br><span class="line">http://xxxxxxxxxxxxx/qsearch/ugc_engine/select?q=*:*&fq=%2B(departure:%E5%8C%97%E4%BA%AC+OR+departure:%E4%B8%AD%E5%9B%BD)&fq=%2B(search_des_path:%E5%8C%97%E4%BA%AC)&fq=audit_time:+[+*+TO+NOW%2B8HOUR+]+AND+end_time:[+NOW%2B8HOUR+TO+*]&fq=status:0&defType=edismax&bq=property:(1)^5000&bq=property:(0)^1000&bq=property:(2)^3&bq=push_start_time:[*+TO+NOW%2B8HOUR+]+AND+push_end_time:[+NOW%2B8HOUR+TO+*]&sort=score+desc,push_start_time+desc,audit_time+desc,quality+desc&start=0&rows=100&fl=en_id,id,score,title,property</span><br><span class="line"></span><br><span class="line">qf参数示例：</span><br><span class="line"></span><br><span class="line">http://xxxxxxxxxxxxxxx/qsearch/ugc_engine/select?q=%E5%8C%97%E4%BA%AC&defType=edismax&qf=search_destination^1000+search_title^100+search_content^10&tie=1&sort=score+desc,quality+desc,audit_time+desc&hl=true&hl.fl=search_title,search_content&hl.simple.pre=%3Cfont+class%3D%22matched%22%3E&hl.simple.post=%3C/font%3E&hl.fragsize=200&start=0&rows=100&fl=score,en_id,id,title,destination,content&fq=audit_time:+[+*+TO+NOW+]+AND+end_time:[+NOW+TO+*]&fq=status:0</span><br></pre></td></tr></tbody></table></figure></div>



<p>4.solr 引擎的 配置说明，dapp-ugc-search-</p>
<p>（1）调试说明</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a.   .dev 中配置要部署的server 名，  (可以ssh 通的)</span><br><span class="line"></span><br><span class="line">b.  执行install脚本   ./install  ，会把 当前工程 编译下，将配置 同步到远程 服务器上 重启solr引擎。</span><br><span class="line"></span><br><span class="line">c.   调试使用，发布还是要走jenkins job， 流程比较规范</span><br></pre></td></tr></tbody></table></figure></div>



<p>(2)新增core 说明 ： 可以copy一个现成的core 然后修改schema，</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a.core下面的core.properties 中的 name： core的名称， dataDir 索引存放的位置</span><br><span class="line"></span><br><span class="line"> name=ugc_engine</span><br><span class="line"> dataDir=/home/q/qsearch-index/ugc_engine</span><br><span class="line"></span><br><span class="line">b.schema.xml 中的引擎名称 修改，</span><br></pre></td></tr></tbody></table></figure></div>



<p>5.solr 引擎的部署说明</p>
<p>6.solr的suggest 实现</p>
<p>ugc中的suggest 功能 是通过 select 实现的，使用单独的core ugc_arr_engine， 每一个doc就是一个目的地， 只进行前缀匹配  在字段类型上 使用EdgeNgram filter 来做前缀匹配</p>
<p>前缀匹配 字段类型：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><fieldtype name="text_ngram_prefix" class="solr.TextField" positionincrementgap="100"></fieldtype></span><br><span class="line"></span><br><span class="line"> <analyzer type="index"></analyzer></span><br><span class="line"> <tokenizer class="solr.KeywordTokenizerFactory"></tokenizer></span><br><span class="line"> <filter class="solr.StopFilterFactory" < span><br><span class="line"> ignoreCase="true"</span><br><span class="line"> words="chinesestopword.txt"</span><br><span class="line"> enablePositionIncrements="true" /></span><br><span class="line"> <filter class="solr.EdgeNGramFilterFactory" mingramsize="1" maxgramsize="8"></filter></span><br><span class="line"> <filter class="solr.LowerCaseFilterFactory"></filter></span><br><span class="line"> </span><br><span class="line"> <analyzer type="query"></analyzer></span><br><span class="line"> <tokenizer class="solr.KeywordTokenizerFactory"></tokenizer></span><br><span class="line"> <filter class="solr.StopFilterFactory" < span><br><span class="line"> ignoreCase="true"</span><br><span class="line"> words="chinesestopword.txt"</span><br><span class="line"> enablePositionIncrements="true" /></span><br><span class="line"> <!--<filter class="solr.EdgeNGramFilterFactory" minGramSize="1" maxGramSize="8"/>--></span><br><span class="line"> <filter class="solr.LowerCaseFilterFactory"></filter></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br></filter></span></filter></span></pre></td></tr></tbody></table></figure></div>



<p>在 solr的Analyse 中进行分析， suggest的实现是 每次 select 去查询，而没有使用solr 本身呆的suggest的模块（因为用select 控制相对灵活，可以根据业务返回需要的字段，而suggest模块 就比较死板，所以采用select 模块 来实现suggest）</p>
<p>7.按照  指定 符号分词，</p>
<p>在des_path字段的格式 一般是   中国/北京/大连，想要将这句话 按照/ 为分隔符 分词，我们需要配置一下 fieldType 配置按照 分隔符分词</p>
<p>使用WordDelimiterFilterFactory filter 以关键字符为分隔符 进行分词</p>
<p>如</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><fieldtype name="textgen" class="solr.TextField" positionincrementgap="100"></fieldtype></span><br><span class="line"> <analyzer type="index"></analyzer></span><br><span class="line"> <tokenizer class="solr.WhitespaceTokenizerFactory"></tokenizer></span><br><span class="line"> <filter class="solr.StopFilterFactory" ignorecase="true" words="stopwords.txt" enablepositionincrements="true"></filter></span><br><span class="line"> <filter class="solr.WordDelimiterFilterFactory" generatewordparts="1" generatenumberparts="1" catenatewords="0" catenatenumbers="0" catenateall="0" splitoncasechange="0"></filter></span><br><span class="line"> <filter class="solr.LowerCaseFilterFactory"></filter></span><br><span class="line"> </span><br><span class="line"> <analyzer type="query"></analyzer></span><br><span class="line"> <tokenizer class="solr.WhitespaceTokenizerFactory"></tokenizer></span><br><span class="line"> <filter class="solr.SynonymFilterFactory" synonyms="synonyms.txt" ignorecase="true" expand="true"></filter></span><br><span class="line"> <filter class="solr.StopFilterFactory" < span><br><span class="line"> ignoreCase="true"</span><br><span class="line"> words="stopwords.txt"</span><br><span class="line"> enablePositionIncrements="true"</span><br><span class="line"> /></span><br><span class="line"> <filter class="solr.WordDelimiterFilterFactory" generatewordparts="1" generatenumberparts="1" catenatewords="0" catenatenumbers="0" catenateall="0" splitoncasechange="0"></filter></span><br><span class="line"> <filter class="solr.LowerCaseFilterFactory"></filter></span><br><span class="line"> </span><br><span class="line"></span><br></filter></span></pre></td></tr></tbody></table></figure></div>



<p>如图 所示，在WDF的filter 下 按照 /  分开了，</p>
<p><a href="https://user-gold-cdn.xitu.io/2018/2/7/1616f6919f56dd23?w=1055&h=716&f=png&s=66076" target="_blank" rel="noopener" data-fancybox="group" data-caption class="fancybox"><img alt title data-src="https://user-gold-cdn.xitu.io/2018/2/7/1616f6919f56dd23?w=1055&h=716&f=png&s=66076" class="lazyload"></a></p>
<h4 id="solr使用中遇到的一些问题"><a href="#solr使用中遇到的一些问题" class="headerlink" title="solr使用中遇到的一些问题"></a>solr使用中遇到的一些问题</h4><p>1.时间问题，</p>
<p>ugc中经常会用 当前时间做查询 ，如 文章是否有效（即 当前时间在 有效时间范围内），使用solr的 NOW 关键字，</p>
<p>solr的now 不是北京时间，使用的时候需要 加8HOUR 在进行比较</p>
<p>如：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sq.addFilterQuery("audit_time: [ * TO NOW+8HOUR ] AND end_time:[ NOW+8HOUR TO *]");//文章是否可显示，必须当前时间在审核时间和下线时间之间</span><br></pre></td></tr></tbody></table></figure></div>



<p>说明： </p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* TO NOW+8HOUR 代表 所有 audit_time 字段 比 当前时间 小的 数据</span><br></pre></td></tr></tbody></table></figure></div>

<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NOW+8HOUR TO *  代表 所有 end_time   字段 比 当前时间 大的 数据。</span><br></pre></td></tr></tbody></table></figure></div>

<p>\2. solr 的 schema 字段 类型， 类型变更问题，如 Date类型</p>
<p>踩坑：solr的索引变换是一个缓慢的过程，之前尝试 将String 类型的字段改成date 类型的，但是 会造成 索引类型不匹配，最开始没什么问题，随时索引慢慢改变， 由于 不匹配导致 该字段的值 会变成  XXXXXXX  origin value ：xxx 的值，</p>
<p>如果想要改变 需要 刘能那边支持 帮忙刷数据，重新建立索引就可以了。</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><field name="create_time" type="date" indexed="true" stored="true"> <!--最后编辑时间--></field></span><br></pre></td></tr></tbody></table></figure></div>



<p>3.solr 查询条件过多的问题</p>
<p>在同步平台数据的需求中， 需要传指定的1300多条数据， 使用qconfig+运营配置id的方式处理， 但是在拼接solr 查询条件的时候 会报错。</p>
<p>因为solr 只支持1024个查询项， 而 每一个id 都会被solr 拆分成一个查询项目，所以无法成功 ， 这里修改了一下solr的配置文件</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><maxbooleanclauses>4096</maxbooleanclauses></span><br></pre></td></tr></tbody></table></figure></div>



<p>即 支持的最多查询项为4096个  。 注意这个选项 需要这个solr 下的所有core 都一样 才会生效。 即把剩余的core 都改成4096</p>
<p>4.solr 查询条件不支持</p>
<p>solr在查询中不支持 某些特殊字符， 如  [  ]   ，比如 在一个查询中 departure ： xxx [xxxx]  solr 是会报错的。</p>
<p>解决方法：在list报错的接口 中添加一个用来过滤 特殊字符的方法，</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">con.filterParam();</span><br></pre></td></tr></tbody></table></figure></div>

<p>用来预处理特殊字符的问题。</p>
<p>5.solr的效率</p>
<p> solr 用作全文检索效率较高，但不适合一次返回很多条的数据的情况。在使用的过程中 尽可能少的 出现solr 返回大量的数据，之前测试 一次几百条，上千条 时间还好，但是不要 过多，也尽量避免 成百上千条的查询。</p>
<p>6.solr的相似度计算</p>
<p>solr 的默认相似度包含的 因素很多，比如词频等，导致 文档的score 不相等的 小数，影响后续的排序，如 首页的排序，是根据score 从高到低排，再根据push_weight 从高到低排序，这样就会导致 排序有问题。</p>
<p>在schema.xml中配置的similarity ， 搜索team 写的， 只使用 权重，这样就可以 让评分 按照自己设定的权重 加分，从而使业务正确<br> <similarity class="com.search.core.score.BoostSimilarityFactory"><br> <!--<str name="paramkey">param value</str>--><br> </similarity></p>
<p>附录：</p>
<p>solrUtils 工具类</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">Code</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import com.google.common.base.Strings;</span><br><span class="line">import org.apache.solr.client.solrj.SolrClient;</span><br><span class="line">import org.apache.solr.client.solrj.SolrQuery;</span><br><span class="line">import org.apache.solr.client.solrj.SolrRequest;</span><br><span class="line">import org.apache.solr.client.solrj.SolrServerException;</span><br><span class="line">import org.apache.solr.client.solrj.impl.CloudSolrClient;</span><br><span class="line">import org.apache.solr.client.solrj.response.QueryResponse;</span><br><span class="line">import org.apache.solr.client.solrj.response.UpdateResponse;</span><br><span class="line">import org.apache.solr.common.SolrDocumentList;</span><br><span class="line">import org.apache.solr.common.SolrInputDocument;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.text.DateFormat;</span><br><span class="line">import java.text.ParseException;</span><br><span class="line">import java.text.SimpleDateFormat;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  solr solrUtils</span><br><span class="line"> * Created by liuyudut.liu on 17-10-10.</span><br><span class="line"> * 该方法依赖于UGCSolrConfig 方法，在UGCSolrConfig 初始化前无法使用。</span><br><span class="line"> * 需要依赖 UGCSolrConfig 在spring 初始化的时候</span><br><span class="line"> * 通过该方法的updateSolrClient 为该方法初始化 并 为client赋值</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public class SolrUtils {</span><br><span class="line">    private final static Logger logger = LoggerFactory.getLogger(SolrUtils.class);</span><br><span class="line"></span><br><span class="line">    private static CloudSolrClient cloudSolrClient ;</span><br><span class="line"></span><br><span class="line">    private static String SOLR_MONITOR_KEY = "solr_search_ugc";</span><br><span class="line"></span><br><span class="line">    private static String SOLR_MONITOR_KEY_POST = "solr_search_ugc_post";</span><br><span class="line"></span><br><span class="line">    private static SolrClient getSolrClient() {</span><br><span class="line">        return cloudSolrClient;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private SolrUtils() {}</span><br><span class="line"></span><br><span class="line">    private static ThreadLocal<dateformat> threadLocal = new ThreadLocal<dateformat>() {</dateformat></dateformat></span><br><span class="line">        @Override</span><br><span class="line">        protected DateFormat initialValue() {</span><br><span class="line">            return new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'");</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    public static Date parse(String dateStr) throws ParseException {</span><br><span class="line">        return threadLocal.get().parse(dateStr);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public static String format(Date date) {</span><br><span class="line">        return threadLocal.get().format(date);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 更新CloudSolrClient变量</span><br><span class="line">     * @param zookhost</span><br><span class="line">     */</span><br><span class="line">    public static void updateSolrClient(String zookhost){</span><br><span class="line">        if(Strings.isNullOrEmpty(zookhost)){</span><br><span class="line">            return;</span><br><span class="line">        }</span><br><span class="line">        CloudSolrClient temp = null;</span><br><span class="line">        try {</span><br><span class="line">            temp = new CloudSolrClient.Builder().withZkHost(zookhost).build();</span><br><span class="line">        }catch (Exception e){</span><br><span class="line">            throw new ValidationRuntimeException("solr zkHost 有误 连接失败",e);</span><br><span class="line">        }</span><br><span class="line">        if(temp != null){</span><br><span class="line">            synchronized (SolrUtils.class){</span><br><span class="line">                cloudSolrClient = temp;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 根据collection,Solrquery搜索数据</span><br><span class="line">     * @param solrCollection</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    public static QueryResponse search (String solrCollection , SolrQuery solrQuery ){</span><br><span class="line">        if(solrQuery == null){</span><br><span class="line">            return null;</span><br><span class="line">        }</span><br><span class="line">        if(Strings.isNullOrEmpty( solrCollection ) ){</span><br><span class="line">            solrCollection = UGCSearchConfig.UGC_SEARCH_SOLR_COLLECTION_DEFAULT;</span><br><span class="line">        }</span><br><span class="line">        Timer.Context solrSearch = QCerberusHelper.buildReqTimer(SOLR_MONITOR_KEY, null,null).time();</span><br><span class="line">        SolrClient solrClient = getSolrClient();</span><br><span class="line">        logger.debug("    solrCollection :    "+solrCollection +"     solrQuery: "+solrQuery.toQueryString());</span><br><span class="line">        QueryResponse qr;</span><br><span class="line">        try {</span><br><span class="line">            qr = solrClient.query(solrCollection,solrQuery);</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            logger.error("    solrCollection :    "+solrCollection +"     solrQuery: "+solrQuery.toQueryString() );</span><br><span class="line">            QCerberusHelper.buildThirdpartyReqExcetionCountMonitor(SOLR_MONITOR_KEY,e.getMessage());</span><br><span class="line">            throw new ValidationRuntimeException("solr 查询失败",e);</span><br><span class="line">        }finally {</span><br><span class="line">            QCerberusHelper.stop(solrSearch);</span><br><span class="line">            QCerberusHelper.count(SOLR_MONITOR_KEY);</span><br><span class="line">        }</span><br><span class="line">        return qr;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * solr  查询 post 方法</span><br><span class="line">     * @param solrCollection</span><br><span class="line">     * @param solrQuery</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static QueryResponse searchWithPost (String solrCollection , SolrQuery solrQuery ){</span><br><span class="line">        if(solrQuery == null){</span><br><span class="line">            return null;</span><br><span class="line">        }</span><br><span class="line">        if(Strings.isNullOrEmpty( solrCollection ) ){</span><br><span class="line">            solrCollection = UGCSearchConfig.UGC_SEARCH_SOLR_COLLECTION_DEFAULT;</span><br><span class="line">        }</span><br><span class="line">        Timer.Context solrSearchWithPost = QCerberusHelper.buildReqTimer(SOLR_MONITOR_KEY_POST, null,null).time();</span><br><span class="line">        SolrClient solrClient = getSolrClient();</span><br><span class="line">        logger.debug("   post query:  solrCollection :    "+solrCollection +"     solrQuery: "+solrQuery.toQueryString());</span><br><span class="line">        QueryResponse qr;</span><br><span class="line">        try {</span><br><span class="line">            qr = solrClient.query(solrCollection,solrQuery, SolrRequest.METHOD.POST);</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            throw new ValidationRuntimeException("solr 查询失败 post query: ",e);</span><br><span class="line">        }finally {</span><br><span class="line">            QCerberusHelper.stop(solrSearchWithPost);</span><br><span class="line">        }</span><br><span class="line">        return qr;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 根据collection,bMap,query搜索数据</span><br><span class="line">     * @param solrCollection</span><br><span class="line">     * @param query</span><br><span class="line">     * @param con</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    public static SolrDocumentList search (String solrCollection , String query , SolrCommonCon con){</span><br><span class="line">        if(Strings.isNullOrEmpty(query)){</span><br><span class="line">            return null;</span><br><span class="line">        }</span><br><span class="line">        if(Strings.isNullOrEmpty( solrCollection ) ){</span><br><span class="line">            solrCollection = UGCSearchConfig.UGC_SEARCH_SOLR_COLLECTION_DEFAULT;</span><br><span class="line">        }</span><br><span class="line">        SolrClient solrClient = getSolrClient();</span><br><span class="line">        SolrQuery sq = new SolrQuery();</span><br><span class="line">        sq.setQuery(query);</span><br><span class="line">        if(con != null){</span><br><span class="line">            sq.set("indent", con.getIndent());</span><br><span class="line">            sq.set("wt", con.getWt());</span><br><span class="line">            sq.set("fl", con.getFl());</span><br><span class="line">            Integer row = con.getRow();</span><br><span class="line">            sq.setRows(row == null? 10 : row);</span><br><span class="line">        }</span><br><span class="line">        QueryResponse qr=null;</span><br><span class="line">        SolrDocumentList docs = null;</span><br><span class="line">        try {</span><br><span class="line">            qr=solrClient.query(solrCollection,sq);</span><br><span class="line">            docs = qr.getResults();</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            throw new ValidationRuntimeException("solr 查询失败",e);</span><br><span class="line">        }</span><br><span class="line">        return docs;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 更新solr数据</span><br><span class="line">     * @param collection</span><br><span class="line">     * @param docs</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static UpdateResponse updateSolrData(String collection , List<solrinputdocument> docs) {</solrinputdocument></span><br><span class="line">        if(Strings.isNullOrEmpty(collection)){</span><br><span class="line">            throw new ValidationRuntimeException("solr 数据上传失败,collection 为空");</span><br><span class="line">        }</span><br><span class="line">        UpdateResponse ur = null;</span><br><span class="line">        try{</span><br><span class="line">            cloudSolrClient.deleteByQuery( collection,"*:*");</span><br><span class="line">            cloudSolrClient.add( collection , docs);</span><br><span class="line">            ur = cloudSolrClient.commit( collection ,false, false);</span><br><span class="line">        }catch (Exception e) {</span><br><span class="line">            throw new ValidationRuntimeException("solr 数据上传失败",e);</span><br><span class="line">        }</span><br><span class="line">        return ur;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public static void destory(){</span><br><span class="line">        try {</span><br><span class="line">            if(cloudSolrClient != null){</span><br><span class="line">                cloudSolrClient.close();</span><br><span class="line">            }</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            throw new ValidationRuntimeException("solr 关闭连接失败",e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description: 添加单个对象到索引</span><br><span class="line">     * @param object</span><br><span class="line">     * @throws IOException</span><br><span class="line">     * @throws SolrServerException</span><br><span class="line">     */</span><br><span class="line">    public void addBean(String collection,Object object) {</span><br><span class="line">        try {</span><br><span class="line">            cloudSolrClient.addBean(collection, object);</span><br><span class="line">            cloudSolrClient.commit(false, false);</span><br><span class="line">        }catch(Exception e){</span><br><span class="line">            throw new QRuntimeException("solr 数据添加失败",e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    /**</span><br><span class="line">     * @Description: 添加集合到索引</span><br><span class="line">     * @param lists</span><br><span class="line">     * @throws IOException</span><br><span class="line">     * @throws SolrServerException</span><br><span class="line">     */</span><br><span class="line">    public <e> void addBeans(String collection ,List<e> lists)</e></e></span><br><span class="line">    {</span><br><span class="line">        try {</span><br><span class="line">            cloudSolrClient.addBeans(collection,lists);</span><br><span class="line">            cloudSolrClient.commit(false, false);</span><br><span class="line">        }catch(Exception e){</span><br><span class="line">            throw new QRuntimeException("solr 数据添加失败",e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    /**</span><br><span class="line">     * @Description: 根据id删除记录</span><br><span class="line">     * @param idName,id</span><br><span class="line">     * @throws IOException</span><br><span class="line">     * @throws SolrServerException</span><br><span class="line">     */</span><br><span class="line">    public void deleteById(String collection, String idName, Object id) {</span><br><span class="line">        try {</span><br><span class="line">            cloudSolrClient.deleteByQuery(collection,idName + ":" + id.toString());</span><br><span class="line">            cloudSolrClient.commit(false, false);</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            throw new QRuntimeException("solr 数据删除失败",e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    /**</span><br><span class="line">     * @Description: 添加单个对象到索引</span><br><span class="line">     * @throws IOException</span><br><span class="line">     * @throws SolrServerException</span><br><span class="line">     */</span><br><span class="line">    public void deleteAll(String collection) {</span><br><span class="line">        try {</span><br><span class="line">            cloudSolrClient.deleteByQuery(collection,"*:*");</span><br><span class="line">            cloudSolrClient.commit(false, false);</span><br><span class="line">        } catch (Exception e) {</span><br><span class="line">            throw new QRuntimeException("solr 数据删除失败",e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @Description: 特殊符号过滤</span><br><span class="line"></span><br><span class="line">     */</span><br><span class="line">    public static String filterCharacter(String query) {</span><br><span class="line">        if(Strings.isNullOrEmpty( query ) ){</span><br><span class="line">            return null;</span><br><span class="line">        }</span><br><span class="line">        if(query.contains("[") || query.contains("]")){</span><br><span class="line">            query = query.replace("[","");</span><br><span class="line">            return query.replace("]","");</span><br><span class="line">        }</span><br><span class="line">        return null;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></div>

</body></html></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">美式不加糖</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/02/04/solr%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/">http://yoursite.com/2020/02/04/solr%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">湖畔小屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/02/04/solr-%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>solr测试数据</span></div></a></div><div class="next-post pull_right"><a href="/2020/02/04/solr%E7%9A%84%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>solr的问题排查（ugc 项目问题排查）</span></div></a></div></nav></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By 美式不加糖</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>